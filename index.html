<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業排班與報表系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background-color: #f8fafc;
        }
        .shift-cell:hover { background-color: #f1f5f9; cursor: pointer; }
        
        /* 報表輸出專用樣式 */
        #printArea { display: none; background: white; width: 210mm; margin: 0 auto; }
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 10px;
            padding: 10px;
        }
        .day-block {
            border: 1px solid #000;
            padding: 5px;
            font-size: 11px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
        }
        .report-table th, .report-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            text-align: center;
            height: 24px;
        }
        .report-header { font-weight: bold; background: #f0f0f0; }

        @media print {
            .no-print { display: none !important; }
            #app { display: none !important; }
            #printArea { display: block !important; }
            body { background: white; padding: 0; }
            @page { size: A4 portrait; margin: 5mm; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- 標題區域 -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 no-print">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">專業排班管理系統</h1>
                <p class="text-slate-500">快速生成、編輯並輸出日報表格式</p>
            </div>
            <div class="flex gap-2">
                <button onclick="generateSchedule()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-sm">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> 自動排班
                </button>
                <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-sm">
                    <i data-lucide="file-text" class="w-4 h-4"></i> 輸出日報表格式
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 no-print">
            <!-- 左側設定欄 -->
            <aside class="lg:col-span-1 space-y-6">
                <!-- 人員管理 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-indigo-500"></i> 人員與班別
                    </h2>
                    <div class="flex flex-col gap-2 mb-4">
                        <input type="text" id="staffInput" placeholder="姓名" class="border border-slate-200 rounded-md px-3 py-1.5 text-sm">
                        <select id="staffGroup" class="border border-slate-200 rounded-md px-3 py-1.5 text-sm">
                            <option value="早班">早班 (08-16)</option>
                            <option value="中班">中班 (16-00)</option>
                            <option value="晚班">晚班 (00-08)</option>
                        </select>
                        <button onclick="addStaff()" class="bg-slate-800 text-white py-1.5 rounded-md hover:bg-slate-700 transition">新增人員</button>
                    </div>
                    <ul id="staffList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- 動態生成 -->
                    </ul>
                </div>
            </aside>

            <!-- 右側編輯區 -->
            <main class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <button onclick="changeWeek(-1)" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="chevron-left"></i></button>
                            <h3 id="currentWeekRange" class="font-bold text-slate-700"></h3>
                            <button onclick="changeWeek(1)" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="chevron-right"></i></button>
                        </div>
                        <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full">點擊單元格可切換「休/上班」</span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="editTable">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="p-3 text-xs font-bold text-slate-500 uppercase sticky left-0 bg-slate-50">人員</th>
                                    <!-- 日期標題 -->
                                </tr>
                            </thead>
                            <tbody id="scheduleBody">
                                <!-- 排班內容 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 報表輸出預覽區 (列印時才顯示) -->
    <div id="printArea">
        <div class="report-grid" id="reportGrid">
            <!-- 動態生成 6 個日區塊 -->
        </div>
    </div>

    <script>
        // 資料初始化
        let staffData = [
            { name: "王小明", group: "早班" },
            { name: "李小華", group: "早班" },
            { name: "張大成", group: "中班" },
            { name: "陳曉美", group: "中班" },
            { name: "林志強", group: "晚班" },
            { name: "黃金發", group: "晚班" }
        ];
        
        // 儲存格式: { '2026-01-26': { '王小明': '08-16', '李小華': '休' } }
        let schedule = {};
        let currentStartDate = new Date(2026, 0, 26); 

        function init() {
            lucide.createIcons();
            renderStaff();
            updateWeekDisplay();
            renderSchedule();
        }

        function renderStaff() {
            const list = document.getElementById('staffList');
            list.innerHTML = staffData.map((s, i) => `
                <li class="flex items-center justify-between bg-slate-50 p-2 rounded border border-slate-100 text-sm group">
                    <span><small class="bg-slate-200 px-1 rounded mr-2 text-[10px]">${s.group}</small>${s.name}</span>
                    <button onclick="removeStaff(${i})" class="text-rose-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </li>
            `).join('');
            lucide.createIcons();
        }

        function addStaff() {
            const name = document.getElementById('staffInput').value.trim();
            const group = document.getElementById('staffGroup').value;
            if (name) {
                staffData.push({ name, group });
                document.getElementById('staffInput').value = '';
                renderStaff();
                renderSchedule();
            }
        }

        function removeStaff(i) {
            staffData.splice(i, 1);
            renderStaff();
            renderSchedule();
        }

        function updateWeekDisplay() {
            const end = new Date(currentStartDate);
            end.setDate(end.getDate() + 6);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            document.getElementById('currentWeekRange').innerText = 
                `${currentStartDate.toLocaleDateString('zh-TW', options)} - ${end.toLocaleDateString('zh-TW', options)}`;
        }

        function changeWeek(offset) {
            currentStartDate.setDate(currentStartDate.getDate() + (offset * 7));
            updateWeekDisplay();
            renderSchedule();
        }

        function generateSchedule() {
            // 簡易隨機排班邏輯：每人每週休 2 天
            for (let i = 0; i < 7; i++) {
                let date = new Date(currentStartDate);
                date.setDate(date.getDate() + i);
                let dateStr = date.toISOString().split('T')[0];
                schedule[dateStr] = {};
                
                staffData.forEach(s => {
                    // 隨機分配休假 (約 25% 機率)
                    const isOff = Math.random() < 0.25;
                    schedule[dateStr][s.name] = isOff ? '休' : (s.group === '早班' ? '08-16' : (s.group === '中班' ? '16-00' : '00-08'));
                });
            }
            renderSchedule();
        }

        function toggleShift(dateStr, name) {
            if (!schedule[dateStr]) schedule[dateStr] = {};
            const current = schedule[dateStr][name];
            const s = staffData.find(x => x.name === name);
            const workTime = s.group === '早班' ? '08-16' : (s.group === '中班' ? '16-00' : '00-08');
            
            schedule[dateStr][name] = (current === '休') ? workTime : '休';
            renderSchedule();
        }

        function renderSchedule() {
            const theadRow = document.querySelector('#editTable thead tr');
            const tbody = document.getElementById('scheduleBody');
            
            // 清除舊表頭
            theadRow.innerHTML = '<th class="p-3 text-xs font-bold text-slate-500 uppercase sticky left-0 bg-slate-50">人員</th>';
            
            const days = [];
            for (let i = 0; i < 7; i++) {
                let date = new Date(currentStartDate);
                date.setDate(date.getDate() + i);
                days.push(date);
                theadRow.innerHTML += `<th class="p-3 text-xs font-bold text-center text-slate-500">${date.getMonth()+1}/${date.getDate()}(${['日','一','二','三','四','五','六'][date.getDay()]})</th>`;
            }

            tbody.innerHTML = staffData.map(s => {
                let row = `<tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="p-3 text-sm font-medium text-slate-700 sticky left-0 bg-white border-r">${s.name}</td>`;
                
                days.forEach(date => {
                    let dateStr = date.toISOString().split('T')[0];
                    let val = (schedule[dateStr] && schedule[dateStr][s.name]) ? schedule[dateStr][s.name] : '-';
                    let cellColor = val === '休' ? 'text-rose-500 font-bold' : 'text-indigo-600';
                    row += `<td class="p-3 text-center text-xs ${cellColor} cursor-pointer hover:bg-indigo-50" onclick="toggleShift('${dateStr}', '${s.name}')">${val}</td>`;
                });
                return row + '</tr>';
            }).join('');

            updatePrintReport();
        }

        // --- 報表輸出核心 ---
        function updatePrintReport() {
            const container = document.getElementById('reportGrid');
            container.innerHTML = '';

            // 只取排班表的前 6 天做示範 (符合圖片 2x3 格式)
            for (let i = 0; i < 6; i++) {
                let date = new Date(currentStartDate);
                date.setDate(date.getDate() + i);
                let dateStr = date.toISOString().split('T')[0];
                let dayData = schedule[dateStr] || {};

                // 分組統計
                const morningArr = staffData.filter(s => s.group === '早班' && dayData[s.name] !== '休').map(s => s.name);
                const afternoonArr = staffData.filter(s => s.group === '中班' && dayData[s.name] !== '休').map(s => s.name);
                const eveningArr = staffData.filter(s => s.group === '晚班' && dayData[s.name] !== '休').map(s => s.name);
                const offArr = staffData.filter(s => dayData[s.name] === '休').map(s => s.name);

                let block = `
                    <div class="day-block">
                        <div class="mb-1 font-bold text-center border-b border-black pb-1">
                            ${date.getMonth()+1}/${date.getDate()}(週${['日','一','二','三','四','五','六'][date.getDay()]})
                        </div>
                        <table class="report-table">
                            <tr class="report-header">
                                <td style="width:15%">班別</td>
                                <td style="width:35%">人力安排</td>
                                <td style="width:14%">崗位</td>
                                <td style="width:12%">08~16</td>
                                <td style="width:12%">16~00</td>
                                <td style="width:12%">00~08</td>
                            </tr>
                            <tr>
                                <td>早班</td>
                                <td>${morningArr.join('、') || ''}</td>
                                <td></td>
                                <td>${morningArr.length || ''}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>中班</td>
                                <td>${afternoonArr.join('、') || ''}</td>
                                <td></td>
                                <td></td>
                                <td>${afternoonArr.length || ''}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>晚班</td>
                                <td>${eveningArr.join('、') || ''}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${eveningArr.length || ''}</td>
                            </tr>
                            <!-- 預留空白行 -->
                            ${'<tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>'.repeat(3)}
                        </table>
                        <div class="mt-1 border-t border-black pt-1 flex justify-between">
                            <span>休假人員：${offArr.join('、') || '無'}</span>
                            <span>發券：__________</span>
                        </div>
                    </div>
                `;
                container.innerHTML += block;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
