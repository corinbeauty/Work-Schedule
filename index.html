<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業月度排班管理系統 - 進階版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background-color: #f1f5f9;
        }
        .table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th, td { 
            border: 1px solid #e2e8f0; 
            text-align: center; 
            padding: 0.3rem 0.2rem; 
            font-size: 0.7rem;
            min-width: 34px;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 10;
            border-right: 2px solid #cbd5e1;
            min-width: 120px;
        }
        .shift-group-col {
            position: sticky;
            left: 0;
            z-index: 11;
            font-weight: bold;
            writing-mode: vertical-rl;
            text-orientation: upright;
            padding: 2px;
            font-size: 9px;
            min-width: 28px !important;
            width: 28px !important;
        }
        .weekend-text { color: #ef4444; font-weight: bold; }
        .holiday-bg { background-color: rgba(254, 226, 226, 0.4); }
        .cell-off { color: #ef4444; font-weight: bold; }
        .cell-resigned { background-color: #f1f5f9; color: #94a3b8; font-style: italic; }
        .name-input { width: 70px; border: none; outline: none; background: transparent; font-size: 0.75rem; }
        .name-input:focus { background: rgba(255,255,255,0.5); border-radius: 4px; }
        
        .group-早班 { background-color: #fefce8; }
        .group-中班 { background-color: #f0fdf4; }
        .group-晚班 { background-color: #eff6ff; }
        .group-夜班 { background-color: #faf5ff; }

        .active-tool { ring: 2px; ring-color: #4f46e5; transform: scale(1.05); }
        
        #reportPrintArea { display: none; }
        @media print {
            .no-print { display: none !important; }
            #app { display: none !important; }
            #reportPrintArea { display: block !important; background: white; }
            .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
            .day-block { border: 1px solid #000; padding: 5px; font-size: 10px; }
            .report-table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 4px; }
            .report-table td { border: 1px solid #000; height: 22px; text-align: center; }
            @page { size: A4 portrait; margin: 5mm; }
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="max-w-full mx-auto">
        <header class="mb-4 flex flex-col md:flex-row justify-between items-end gap-4 no-print">
            <div class="flex items-end gap-6">
                <div>
                    <h1 id="tableTitle" class="text-xl font-bold text-slate-800">月度預排休假表</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-200 rounded transition"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <span id="monthDisplay" class="font-medium text-slate-600 text-sm">2026年 2月</span>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-200 rounded transition"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                </div>
                
                <div class="flex gap-1 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                    <button onclick="undo()" id="undoBtn" class="p-1 text-slate-400 hover:text-indigo-600 disabled:opacity-30 transition" title="復原 (Ctrl+Z)">
                        <i data-lucide="undo-2" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="redo()" id="redoBtn" class="p-1 text-slate-400 hover:text-indigo-600 disabled:opacity-30 transition" title="下一步 (Ctrl+Y)">
                        <i data-lucide="redo-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white p-1.5 rounded-lg shadow-sm border border-slate-200 flex gap-2 items-center">
                <span class="text-[10px] font-bold text-slate-400 px-1 uppercase tracking-wider">工具：</span>
                <div id="toolbar" class="flex gap-1"></div>
            </div>

            <div class="flex gap-2">
                <button onclick="window.print()" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs hover:bg-slate-900 transition shadow-sm">
                    <i data-lucide="printer" class="w-3 h-3"></i> 輸出日報表
                </button>
            </div>
        </header>

        <div class="table-wrapper no-print">
            <table id="monthlyTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFoot"></tfoot>
            </table>
        </div>

        <div class="mt-3 text-[10px] text-slate-400 no-print flex flex-wrap gap-4 uppercase tracking-tighter">
            <span class="flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> 套用工具：點選上方工具後點擊表格</span>
            <span>● 「初二/十六」自動依農曆標記</span>
            <span>● 支援 Ctrl+Z/Y 快捷鍵</span>
        </div>
    </div>

    <div id="resignModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-5 rounded-xl shadow-xl w-72">
            <h3 class="text-base font-bold mb-2">離職狀態確認</h3>
            <p id="resignText" class="text-xs text-slate-600 mb-5">是否將此人員從今日起至月底一同標記？</p>
            <div class="flex justify-end gap-2">
                <button onclick="handleResignConfirm(false)" class="px-3 py-1.5 text-slate-500 hover:bg-slate-100 rounded-lg text-[11px]">僅今日</button>
                <button onclick="handleResignConfirm(true)" class="px-3 py-1.5 bg-rose-600 text-white hover:bg-rose-700 rounded-lg text-[11px]">後面全部標記</button>
            </div>
        </div>
    </div>

    <div id="reportPrintArea">
        <div id="reportGrid" class="report-grid"></div>
    </div>

    <script>
        let currentYear = 2026;
        let currentMonth = 1;
        let selectedTool = ""; 

        let historyStack = [];
        let redoStack = [];

        const shiftTypes = [
            { id: "", label: "清除", color: "bg-slate-100 text-slate-600" },
            { id: "休", label: "休", color: "bg-rose-100 text-rose-600" },
            { id: "08", label: "08", color: "bg-emerald-100 text-emerald-600" },
            { id: "1430", label: "1430", color: "bg-blue-100 text-blue-600" },
            { id: "特", label: "特", color: "bg-amber-100 text-amber-600" },
            { id: "離職", label: "離職", color: "bg-slate-200 text-slate-400" }
        ];

        let staffGroups = [
            { group: "早班", members: ["黃詩涵", "劉芸汶", "林詩涵"] },
            { group: "中班", members: ["賴彥廷", "莊秉豐", "黃靖雯", "呂佳霖"] },
            { group: "晚班", members: ["莊雅筑", "賴信吉", "柏政權", "待補"] },
            { group: "夜班", members: ["黃品睿", "王楷翔", "施孟均"] }
        ];

        // 台灣 2026 國定假日 + 農曆初二、十六 (作牙/拜拜)
        const taiwanHolidays = {
            "2026-01-01": "元旦",
            "2026-01-20": "初二", // 臘月
            "2026-02-03": "十六", // 臘月
            "2026-02-16": "除夕", "2026-02-17": "初一", "2026-02-18": "初二", "2026-02-19": "初三", "2026-02-20": "初四", "2026-02-21": "初五",
            "2026-02-28": "228紀念日",
            "2026-03-04": "十六",
            "2026-03-20": "初二",
            "2026-04-03": "十六/清明", "2026-04-04": "清明節",
            "2026-04-18": "初二",
            "2026-05-01": "勞動節", "2026-05-02": "十六",
            "2026-05-17": "初二", "2026-05-31": "十六",
            "2026-06-16": "初二", "2026-06-19": "端午節", "2026-06-30": "十六",
            "2026-07-15": "初二", "2026-07-29": "十六",
            "2026-08-14": "初二", "2026-08-28": "十六",
            "2026-09-12": "初二", "2026-09-25": "中秋節", "2026-09-26": "十六",
            "2026-10-10": "國慶日", "2026-10-12": "初二", "2026-10-26": "十六",
            "2026-11-10": "初二", "2026-11-24": "十六",
            "2026-12-10": "初二", "2026-12-24": "十六"
        };

        let schedule = {};
        let resignContext = null;

        function init() {
            renderToolbar();
            renderMonthlyTable();
            updateHistoryButtons();
            lucide.createIcons();
            
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') { e.preventDefault(); undo(); }
                    if (e.key === 'y') { e.preventDefault(); redo(); }
                }
            });
        }

        function saveHistory() {
            historyStack.push({
                schedule: JSON.parse(JSON.stringify(schedule)),
                staffGroups: JSON.parse(JSON.stringify(staffGroups))
            });
            redoStack = [];
            if (historyStack.length > 50) historyStack.shift();
            updateHistoryButtons();
        }

        function undo() {
            if (historyStack.length === 0) return;
            redoStack.push({
                schedule: JSON.parse(JSON.stringify(schedule)),
                staffGroups: JSON.parse(JSON.stringify(staffGroups))
            });
            const lastState = historyStack.pop();
            schedule = lastState.schedule;
            staffGroups = lastState.staffGroups;
            renderMonthlyTable();
            updateHistoryButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            historyStack.push({
                schedule: JSON.parse(JSON.stringify(schedule)),
                staffGroups: JSON.parse(JSON.stringify(staffGroups))
            });
            const nextState = redoStack.pop();
            schedule = nextState.schedule;
            staffGroups = nextState.staffGroups;
            renderMonthlyTable();
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            const uBtn = document.getElementById('undoBtn');
            const rBtn = document.getElementById('redoBtn');
            uBtn.disabled = historyStack.length === 0;
            rBtn.disabled = redoStack.length === 0;
        }

        function renderToolbar() {
            const container = document.getElementById('toolbar');
            container.innerHTML = shiftTypes.map(t => `
                <button onclick="selectTool('${t.id}')" id="tool-${t.id}" 
                        class="${t.color} px-2.5 py-1 rounded text-[10px] font-bold transition-all hover:brightness-95 border border-transparent">
                    ${t.label || '空'}
                </button>
            `).join('');
            selectTool(""); 
        }

        function selectTool(id) {
            selectedTool = id;
            shiftTypes.forEach(t => {
                const btn = document.getElementById(`tool-${t.id}`);
                if (t.id === id) btn.classList.add('ring-2', 'ring-indigo-500', 'border-white');
                else btn.classList.remove('ring-2', 'ring-indigo-500', 'border-white');
            });
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getWeather(date) {
            const month = date.getMonth();
            const day = date.getDate();
            const seed = (month * 31 + day) % 10;
            if (month <= 2 || month >= 10) {
                if (seed < 3) return { label: "雨", color: "text-blue-400" };
                if (seed < 7) return { label: "冷", color: "text-indigo-500" };
                return { label: "暖", color: "text-orange-400" };
            } else {
                if (seed < 2) return { label: "雨", color: "text-blue-400" };
                if (seed < 8) return { label: "晴", color: "text-amber-500" };
                return { label: "暖", color: "text-rose-500" };
            }
        }

        function changeMonth(offset) {
            currentMonth += offset;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderMonthlyTable();
        }

        function renderMonthlyTable() {
            const daysCount = getDaysInMonth(currentYear, currentMonth);
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            const foot = document.getElementById('tableFoot');
            const weekNames = ["日", "一", "二", "三", "四", "五", "六"];

            document.getElementById('monthDisplay').innerText = `${currentYear}年 ${currentMonth + 1}月`;

            let h_weather = `<tr class="bg-slate-50"><th colspan="2" class="sticky-col bg-slate-50 text-[9px] text-slate-300">天氣</th>`;
            let h1 = `<tr class="bg-slate-50"><th colspan="2" class="sticky-col bg-slate-50">節慶</th>`;
            let h2 = `<tr><th class="sticky-col" style="min-width:28px">班別</th><th class="sticky-col" style="left:28px">姓名</th>`;
            let h3 = `<tr><th colspan="2" class="sticky-col"></th>`;

            for (let d = 1; d <= daysCount; d++) {
                let date = new Date(currentYear, currentMonth, d);
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let holidayName = taiwanHolidays[dateStr] || "";
                let isWeekend = (date.getDay() === 0 || date.getDay() === 6);
                let colorClass = (holidayName !== "" || isWeekend) ? "weekend-text" : "";
                const weather = getWeather(date);

                h_weather += `<th class="${weather.color} font-bold text-[9px]">${weather.label}</th>`;
                h1 += `<th class="${colorClass} text-[9px] leading-tight">${holidayName}</th>`;
                h2 += `<th class="${colorClass}">${d}</th>`;
                h3 += `<th class="${colorClass} text-[9px]">${weekNames[date.getDay()]}</th>`;
            }
            h_weather += `<th class="bg-slate-100"></th></tr>`;
            h1 += `<th rowspan="3" class="w-10 bg-slate-100 text-[9px]">共休</th></tr>`;
            head.innerHTML = h_weather + h1 + h2 + h3;

            let bodyHtml = "";
            staffGroups.forEach((g, gIdx) => {
                const groupClass = `group-${g.group}`;
                g.members.forEach((name, mIdx) => {
                    let row = `<tr class="${groupClass}">`;
                    if (mIdx === 0) {
                        row += `<td rowspan="${g.members.length}" class="shift-group-col bg-slate-50 border-r border-slate-200">
                                    <div class="flex flex-col items-center justify-center h-full gap-1">
                                        <span>${g.group}</span>
                                        <button onclick="addMember(${gIdx})" class="no-print bg-indigo-500 text-white rounded w-3 h-3 flex items-center justify-center hover:bg-indigo-600 shadow-sm">
                                            <i data-lucide="plus" class="w-2 h-2"></i>
                                        </button>
                                    </div>
                                </td>`;
                    }
                    row += `<td class="sticky-col text-left font-medium px-1 flex items-center justify-between" style="left:28px; min-width:92px">
                                <input type="text" value="${name}" class="name-input" onchange="updateMemberName(${gIdx}, ${mIdx}, this.value)">
                                <button onclick="removeMember(${gIdx}, ${mIdx})" class="no-print text-slate-300 hover:text-rose-500">
                                    <i data-lucide="minus-circle" class="w-2.5 h-2.5"></i>
                                </button>
                            </td>`;
                    
                    let personOffCount = 0;
                    for (let d = 1; d <= daysCount; d++) {
                        let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        let value = (schedule[dateStr] && schedule[dateStr][name]) ? schedule[dateStr][name] : "";
                        let isWeekend = (new Date(currentYear, currentMonth, d).getDay() === 0 || new Date(currentYear, currentMonth, d).getDay() === 6);
                        
                        let cellClass = "";
                        if (value === "休") { cellClass = "cell-off"; personOffCount++; }
                        if (value === "離職") cellClass = "cell-resigned";
                        
                        row += `<td class="cursor-pointer hover:bg-white/50 transition ${cellClass} ${isWeekend && value !== '離職'?'holiday-bg':''}" 
                                    onclick="applyTool('${dateStr}', '${name}', ${d})">${value}</td>`;
                    }
                    row += `<td class="font-bold bg-slate-50/50">${personOffCount}</td></tr>`;
                    bodyHtml += row;
                });
            });
            body.innerHTML = bodyHtml;

            let footHtml = `<tr class="bg-slate-100 font-bold"><td colspan="2" class="sticky-col bg-slate-100 text-[9px]">休假統計</td>`;
            for (let d = 1; d <= daysCount; d++) {
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let count = 0;
                if (schedule[dateStr]) {
                    Object.values(schedule[dateStr]).forEach(v => { if (v === "休") count++; });
                }
                footHtml += `<td class="text-rose-600">${count || ""}</td>`;
            }
            footHtml += `<td></td></tr>`;
            foot.innerHTML = footHtml;

            lucide.createIcons();
            updatePrintReport();
        }

        function addMember(gIdx) {
            saveHistory();
            staffGroups[gIdx].members.push("新人員");
            renderMonthlyTable();
        }

        function removeMember(gIdx, mIdx) {
            saveHistory();
            staffGroups[gIdx].members.splice(mIdx, 1);
            renderMonthlyTable();
        }

        function updateMemberName(gIdx, mIdx, newName) {
            saveHistory();
            const oldName = staffGroups[gIdx].members[mIdx];
            staffGroups[gIdx].members[mIdx] = newName;
            Object.keys(schedule).forEach(date => {
                if (schedule[date][oldName]) {
                    schedule[date][newName] = schedule[date][oldName];
                    delete schedule[date][oldName];
                }
            });
            renderMonthlyTable();
        }

        function applyTool(dateStr, name, dayNum) {
            if (!schedule[dateStr]) schedule[dateStr] = {};
            if (selectedTool === "離職") {
                resignContext = { dateStr, name, dayNum };
                document.getElementById('resignText').innerText = `是否將 ${name} 從 ${dateStr} 之後一同標記？`;
                document.getElementById('resignModal').classList.remove('hidden');
            } else if (schedule[dateStr][name] !== selectedTool) {
                saveHistory();
                schedule[dateStr][name] = selectedTool;
                renderMonthlyTable();
            }
        }

        function handleResignConfirm(applyToFuture) {
            saveHistory();
            const { dateStr, name, dayNum } = resignContext;
            const daysCount = getDaysInMonth(currentYear, currentMonth);
            if (applyToFuture) {
                for (let d = dayNum; d <= daysCount; d++) {
                    let dStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    if (!schedule[dStr]) schedule[dStr] = {};
                    schedule[dStr][name] = "離職";
                }
            } else schedule[dateStr][name] = "離職";
            document.getElementById('resignModal').classList.add('hidden');
            resignContext = null;
            renderMonthlyTable();
        }

        function updatePrintReport() {
            const container = document.getElementById('reportGrid');
            container.innerHTML = '';
            const daysCount = getDaysInMonth(currentYear, currentMonth);
            for (let d = 1; d <= daysCount; d++) {
                let date = new Date(currentYear, currentMonth, d);
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let dayData = schedule[dateStr] || {};
                const getWorking = (group) => {
                    const g = staffGroups.find(g => g.group === group);
                    return g ? g.members.filter(m => dayData[m] && dayData[m] !== '休' && dayData[m] !== '離職' && m !== '待補') : [];
                };
                const morning = getWorking("早班"), afternoon = getWorking("中班"), evening = getWorking("晚班");
                const holidaysList = Object.keys(dayData).filter(m => dayData[m] === '休');
                container.innerHTML += `<div class="day-block"><div class="font-bold text-center border-b border-black pb-1">${currentMonth+1}/${d} (${["週日","週一","週二","週三","週四","週五","週六"][date.getDay()]})</div><table class="report-table text-[9px]"><tr class="bg-gray-100 font-bold"><td width="15%">班別</td><td width="35%">人力安排</td><td width="14%">崗位</td><td width="12%">08~16</td><td width="12%">16~00</td><td width="12%">00~08</td></tr><tr><td>早班</td><td>${morning.join('、')}</td><td></td><td>${morning.length || ''}</td><td></td><td></td></tr><tr><td>中班</td><td>${afternoon.join('、')}</td><td></td><td></td><td>${afternoon.length || ''}</td><td></td></tr><tr><td>晚班</td><td>${evening.join('、')}</td><td></td><td></td><td></td><td>${evening.length || ''}</td></tr>${'<tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>'.repeat(2)}</table><div class="mt-2 text-[9px]"><div>休假人員：${holidaysList.join('、') || '無'}</div></div></div>`;
            }
        }
        window.onload = init;
    </script>
</body>
</html>
