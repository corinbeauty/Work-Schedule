<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業月度排班管理系統 - 進階版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif;
            background-color: #f1f5f9;
        }
        .table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th, td { 
            border: 1px solid #e2e8f0; 
            text-align: center; 
            padding: 0.4rem; 
            font-size: 0.75rem;
            min-width: 38px;
        }
        .sticky-col {
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 10;
            border-right: 2px solid #cbd5e1;
            min-width: 140px;
        }
        .shift-group-col {
            position: sticky;
            left: 0;
            z-index: 11;
            font-weight: bold;
            writing-mode: vertical-rl;
            text-orientation: upright;
            padding: 10px 4px;
        }
        .weekend-text { color: #ef4444; font-weight: bold; }
        .holiday-bg { background-color: rgba(254, 226, 226, 0.4); }
        .cell-off { color: #ef4444; font-weight: bold; }
        .cell-resigned { background-color: #f1f5f9; color: #94a3b8; font-style: italic; }
        .name-input { width: 80px; border: none; outline: none; background: transparent; }
        .name-input:focus { background: rgba(255,255,255,0.5); border-radius: 4px; }
        
        /* 班別色彩 */
        .group-早班 { background-color: #fefce8; } /* 淺黃 */
        .group-中班 { background-color: #f0fdf4; } /* 淺綠 */
        .group-晚班 { background-color: #eff6ff; } /* 淺藍 */
        .group-夜班 { background-color: #faf5ff; } /* 淺紫 */

        .active-tool { ring: 2px; ring-color: #4f46e5; transform: scale(1.05); }
        
        #reportPrintArea { display: none; }
        @media print {
            .no-print { display: none !important; }
            #app { display: none !important; }
            #reportPrintArea { display: block !important; background: white; }
            .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
            .day-block { border: 1px solid #000; padding: 5px; font-size: 10px; }
            .report-table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-top: 4px; }
            .report-table td { border: 1px solid #000; height: 22px; text-align: center; }
            @page { size: A4 portrait; margin: 5mm; }
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="max-w-full mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-end gap-4 no-print">
            <div class="flex items-end gap-6">
                <div>
                    <h1 id="tableTitle" class="text-2xl font-bold text-slate-800">月度預排休假表</h1>
                    <div class="flex items-center gap-3 mt-2">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <span id="monthDisplay" class="font-medium text-slate-600">2026年 2月</span>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <!-- 復原/重做 按鈕 -->
                <div class="flex gap-1 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                    <button onclick="undo()" id="undoBtn" class="p-1.5 text-slate-400 hover:text-indigo-600 disabled:opacity-30 disabled:hover:text-slate-400 transition" title="復原 (Ctrl+Z)">
                        <i data-lucide="undo-2" class="w-4 h-4"></i>
                    </button>
                    <button onclick="redo()" id="redoBtn" class="p-1.5 text-slate-400 hover:text-indigo-600 disabled:opacity-30 disabled:hover:text-slate-400 transition" title="下一步 (Ctrl+Y)">
                        <i data-lucide="redo-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- 班次工具列選擇器 -->
            <div class="bg-white p-2 rounded-xl shadow-sm border border-slate-200 flex gap-2 items-center">
                <span class="text-xs font-bold text-slate-400 px-2">快速選擇：</span>
                <div id="toolbar" class="flex gap-1">
                    <!-- JS 動態生成 -->
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm hover:bg-slate-900 transition shadow-sm">
                    <i data-lucide="printer" class="w-4 h-4"></i> 輸出日報表格式
                </button>
            </div>
        </header>

        <div class="table-wrapper no-print">
            <table id="monthlyTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFoot"></tfoot>
            </table>
        </div>

        <div class="mt-4 text-xs text-slate-400 no-print flex flex-wrap gap-4">
            <span class="flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> 點擊工具列班次後，再點擊表格內容即可套用</span>
            <span>● 點擊「+」可新增該班別人員</span>
            <span>● 點擊姓名可修改</span>
            <span>● 支援快捷鍵 Ctrl+Z 復原 / Ctrl+Y 重做</span>
        </div>
    </div>

    <!-- 離職確認彈窗 -->
    <div id="resignModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 no-print">
        <div class="bg-white p-6 rounded-xl shadow-xl w-80">
            <h3 class="text-lg font-bold mb-2">離職狀態確認</h3>
            <p id="resignText" class="text-sm text-slate-600 mb-6">是否將此人員從今日起至月底的所有日期皆標記為「離職」？</p>
            <div class="flex justify-end gap-2">
                <button onclick="handleResignConfirm(false)" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">僅今日</button>
                <button onclick="handleResignConfirm(true)" class="px-4 py-2 bg-rose-600 text-white hover:bg-rose-700 rounded-lg text-sm">後面日期一同標記</button>
            </div>
        </div>
    </div>

    <div id="reportPrintArea">
        <div id="reportGrid" class="report-grid"></div>
    </div>

    <script>
        let currentYear = 2026;
        let currentMonth = 1;
        let selectedTool = ""; 

        // 歷史記錄棧
        let historyStack = [];
        let redoStack = [];

        const shiftTypes = [
            { id: "", label: "清除", color: "bg-slate-100 text-slate-600" },
            { id: "休", label: "休", color: "bg-rose-100 text-rose-600" },
            { id: "08", label: "08", color: "bg-emerald-100 text-emerald-600" },
            { id: "1430", label: "1430", color: "bg-blue-100 text-blue-600" },
            { id: "特", label: "特", color: "bg-amber-100 text-amber-600" },
            { id: "離職", label: "離職", color: "bg-slate-200 text-slate-400" }
        ];

        let staffGroups = [
            { group: "早班", members: ["黃詩涵", "劉芸汶", "林詩涵"] },
            { group: "中班", members: ["賴彥廷", "莊秉豐", "黃靖雯", "呂佳霖"] },
            { group: "晚班", members: ["莊雅筑", "賴信吉", "柏政權", "待補"] },
            { group: "夜班", members: ["黃品睿", "王楷翔", "施孟均"] }
        ];

        const holidays = {
            "2026-02-16": "除夕", "2026-02-17": "初一", "2026-02-18": "初二",
            "2026-02-19": "初三", "2026-02-20": "初四", "2026-02-21": "初五",
            "2026-02-28": "228紀念日"
        };

        let schedule = {};
        let resignContext = null;

        function init() {
            renderToolbar();
            renderMonthlyTable();
            updateHistoryButtons();
            lucide.createIcons();
            
            // 監聽快捷鍵
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') { e.preventDefault(); undo(); }
                    if (e.key === 'y') { e.preventDefault(); redo(); }
                }
            });
        }

        // --- 歷史記錄核心 ---
        function saveHistory() {
            historyStack.push({
                schedule: JSON.parse(JSON.stringify(schedule)),
                staffGroups: JSON.parse(JSON.stringify(staffGroups))
            });
            redoStack = []; // 有新動作時清空重做棧
            if (historyStack.length > 50) historyStack.shift(); // 限制 50 步
            updateHistoryButtons();
        }

        function undo() {
            if (historyStack.length === 0) return;
            redoStack.push({
                schedule: JSON.parse(JSON.stringify(schedule)),
                staffGroups: JSON.parse(JSON.stringify(staffGroups))
            });
            const lastState = historyStack.pop();
            schedule = lastState.schedule;
            staffGroups = lastState.staffGroups;
            renderMonthlyTable();
            updateHistoryButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            historyStack.push({
                schedule: JSON.parse(JSON.stringify(schedule)),
                staffGroups: JSON.parse(JSON.stringify(staffGroups))
            });
            const nextState = redoStack.pop();
            schedule = nextState.schedule;
            staffGroups = nextState.staffGroups;
            renderMonthlyTable();
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            const uBtn = document.getElementById('undoBtn');
            const rBtn = document.getElementById('redoBtn');
            uBtn.disabled = historyStack.length === 0;
            rBtn.disabled = redoStack.length === 0;
            
            uBtn.classList.toggle('text-slate-400', uBtn.disabled);
            uBtn.classList.toggle('text-indigo-600', !uBtn.disabled);
            rBtn.classList.toggle('text-slate-400', rBtn.disabled);
            rBtn.classList.toggle('text-indigo-600', !rBtn.disabled);
        }

        // --- 介面渲染 ---
        function renderToolbar() {
            const container = document.getElementById('toolbar');
            container.innerHTML = shiftTypes.map(t => `
                <button onclick="selectTool('${t.id}')" id="tool-${t.id}" 
                        class="${t.color} px-3 py-1 rounded-lg text-xs font-bold transition-all hover:brightness-95 border border-transparent">
                    ${t.label || '空'}
                </button>
            `).join('');
            selectTool(""); 
        }

        function selectTool(id) {
            selectedTool = id;
            shiftTypes.forEach(t => {
                const btn = document.getElementById(`tool-${t.id}`);
                if (t.id === id) {
                    btn.classList.add('ring-2', 'ring-indigo-500', 'border-white', 'shadow-sm');
                } else {
                    btn.classList.remove('ring-2', 'ring-indigo-500', 'border-white', 'shadow-sm');
                }
            });
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getWeather(date) {
            const month = date.getMonth();
            const day = date.getDate();
            const seed = (month * 31 + day) % 10;
            if (month <= 2 || month >= 10) {
                if (seed < 3) return { label: "雨", color: "text-blue-400" };
                if (seed < 7) return { label: "冷", color: "text-indigo-500" };
                return { label: "暖", color: "text-orange-400" };
            } else {
                if (seed < 2) return { label: "雨", color: "text-blue-400" };
                if (seed < 8) return { label: "晴", color: "text-amber-500" };
                return { label: "暖", color: "text-rose-500" };
            }
        }

        function changeMonth(offset) {
            currentMonth += offset;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderMonthlyTable();
        }

        function renderMonthlyTable() {
            const daysCount = getDaysInMonth(currentYear, currentMonth);
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            const foot = document.getElementById('tableFoot');
            const weekNames = ["日", "一", "二", "三", "四", "五", "六"];

            document.getElementById('tableTitle').innerText = `${currentMonth + 1}月 預排休假表`;
            document.getElementById('monthDisplay').innerText = `${currentYear}年 ${currentMonth + 1}月`;

            let h_weather = `<tr class="bg-slate-50"><th colspan="2" class="sticky-col bg-slate-50 text-[10px] text-slate-400">天氣</th>`;
            let h1 = `<tr class="bg-slate-50"><th colspan="2" class="sticky-col bg-slate-50">節慶</th>`;
            let h2 = `<tr><th class="sticky-col">班別</th><th class="sticky-col" style="left:40px">姓名/星期</th>`;
            let h3 = `<tr><th colspan="2" class="sticky-col"></th>`;

            for (let d = 1; d <= daysCount; d++) {
                let date = new Date(currentYear, currentMonth, d);
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let isHoliday = holidays[dateStr] || false;
                let isWeekend = (date.getDay() === 0 || date.getDay() === 6);
                let colorClass = (isHoliday || isWeekend) ? "weekend-text" : "";
                const weather = getWeather(date);

                h_weather += `<th class="${weather.color} font-bold text-[10px]">${weather.label}</th>`;
                h1 += `<th class="${colorClass} text-[10px]">${holidays[dateStr] || ""}</th>`;
                h2 += `<th class="${colorClass}">${d}</th>`;
                h3 += `<th class="${colorClass}">${weekNames[date.getDay()]}</th>`;
            }
            h_weather += `<th class="bg-slate-100"></th></tr>`;
            h1 += `<th rowspan="3" class="w-12 bg-slate-100">共休</th></tr>`;
            head.innerHTML = h_weather + h1 + h2 + h3;

            let bodyHtml = "";
            staffGroups.forEach((g, gIdx) => {
                const groupClass = `group-${g.group}`;
                g.members.forEach((name, mIdx) => {
                    let row = `<tr class="${groupClass}">`;
                    if (mIdx === 0) {
                        row += `<td rowspan="${g.members.length}" class="shift-group-col bg-slate-50 border-r-2 border-slate-200">
                                    <div class="flex flex-col items-center gap-1.5">
                                        <span class="text-[11px] mb-0.5">${g.group}</span>
                                        <button onclick="addMember(${gIdx})" class="no-print bg-indigo-500 text-white rounded-full p-0.5 hover:bg-indigo-600 shadow-sm">
                                            <i data-lucide="plus" class="w-2.5 h-2.5"></i>
                                        </button>
                                    </div>
                                </td>`;
                    }
                    row += `<td class="sticky-col text-left font-medium px-2 flex items-center justify-between" style="left:40px">
                                <input type="text" value="${name}" class="name-input" onchange="updateMemberName(${gIdx}, ${mIdx}, this.value)">
                                <button onclick="removeMember(${gIdx}, ${mIdx})" class="no-print text-slate-400/50 hover:text-rose-500">
                                    <i data-lucide="minus-circle" class="w-3 h-3"></i>
                                </button>
                            </td>`;
                    
                    let personOffCount = 0;
                    for (let d = 1; d <= daysCount; d++) {
                        let date = new Date(currentYear, currentMonth, d);
                        let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        let value = (schedule[dateStr] && schedule[dateStr][name]) ? schedule[dateStr][name] : "";
                        let isWeekend = (date.getDay() === 0 || date.getDay() === 6);
                        
                        let cellClass = "";
                        if (value === "休") { cellClass = "cell-off"; personOffCount++; }
                        if (value === "離職") { cellClass = "cell-resigned"; }
                        
                        row += `<td class="cursor-pointer hover:bg-white/60 transition ${cellClass} ${isWeekend && value !== '離職'?'holiday-bg':''}" 
                                    onclick="applyTool('${dateStr}', '${name}', ${d})">${value}</td>`;
                    }
                    row += `<td class="font-bold bg-slate-50/50">${personOffCount}</td></tr>`;
                    bodyHtml += row;
                });
            });
            body.innerHTML = bodyHtml;

            let footHtml = `<tr class="bg-slate-100 font-bold"><td colspan="2" class="sticky-col bg-slate-100">每日休假人數</td>`;
            for (let d = 1; d <= daysCount; d++) {
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let count = 0;
                if (schedule[dateStr]) {
                    Object.values(schedule[dateStr]).forEach(v => { if (v === "休") count++; });
                }
                footHtml += `<td>${count || ""}</td>`;
            }
            footHtml += `<td></td></tr>`;
            foot.innerHTML = footHtml;

            lucide.createIcons();
            updatePrintReport();
        }

        // --- 功能操作與歷史保存 ---
        function addMember(gIdx) {
            saveHistory();
            staffGroups[gIdx].members.push("新人員");
            renderMonthlyTable();
        }

        function removeMember(gIdx, mIdx) {
            saveHistory();
            staffGroups[gIdx].members.splice(mIdx, 1);
            renderMonthlyTable();
        }

        function updateMemberName(gIdx, mIdx, newName) {
            saveHistory();
            const oldName = staffGroups[gIdx].members[mIdx];
            staffGroups[gIdx].members[mIdx] = newName;
            Object.keys(schedule).forEach(date => {
                if (schedule[date][oldName]) {
                    schedule[date][newName] = schedule[date][oldName];
                    delete schedule[date][oldName];
                }
            });
            renderMonthlyTable();
        }

        function applyTool(dateStr, name, dayNum) {
            if (!schedule[dateStr]) schedule[dateStr] = {};
            
            if (selectedTool === "離職") {
                resignContext = { dateStr, name, dayNum };
                document.getElementById('resignText').innerText = `是否將 ${name} 從 ${dateStr} 之後的所有日期皆標記為「離職」？`;
                document.getElementById('resignModal').classList.remove('hidden');
            } else {
                if (schedule[dateStr][name] !== selectedTool) {
                    saveHistory();
                    schedule[dateStr][name] = selectedTool;
                    renderMonthlyTable();
                }
            }
        }

        function handleResignConfirm(applyToFuture) {
            saveHistory();
            const { dateStr, name, dayNum } = resignContext;
            const daysCount = getDaysInMonth(currentYear, currentMonth);

            if (applyToFuture) {
                for (let d = dayNum; d <= daysCount; d++) {
                    let dStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    if (!schedule[dStr]) schedule[dStr] = {};
                    schedule[dStr][name] = "離職";
                }
            } else {
                schedule[dateStr][name] = "離職";
            }

            document.getElementById('resignModal').classList.add('hidden');
            resignContext = null;
            renderMonthlyTable();
        }

        function updatePrintReport() {
            const container = document.getElementById('reportGrid');
            container.innerHTML = '';
            const daysCount = getDaysInMonth(currentYear, currentMonth);

            for (let d = 1; d <= daysCount; d++) {
                let date = new Date(currentYear, currentMonth, d);
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let dayData = schedule[dateStr] || {};

                const getWorking = (group) => {
                    const g = staffGroups.find(g => g.group === group);
                    if (!g) return [];
                    return g.members.filter(m => dayData[m] && dayData[m] !== '休' && dayData[m] !== '離職' && m !== '待補');
                };

                const morning = getWorking("早班");
                const afternoon = getWorking("中班");
                const evening = getWorking("晚班");
                const holidaysList = Object.keys(dayData).filter(m => dayData[m] === '休');

                let block = `
                    <div class="day-block">
                        <div class="font-bold text-center border-b border-black pb-1">
                            ${currentMonth+1}/${d} (${["週日","週一","週二","週三","週四","週五","週六"][date.getDay()]})
                        </div>
                        <table class="report-table text-[9px]">
                            <tr class="bg-gray-100 font-bold">
                                <td width="15%">班別</td><td width="35%">人力安排</td><td width="14%">崗位</td>
                                <td width="12%">08~16</td><td width="12%">16~00</td><td width="12%">00~08</td>
                            </tr>
                            <tr><td>早班</td><td>${morning.join('、')}</td><td></td><td>${morning.length || ''}</td><td></td><td></td></tr>
                            <tr><td>中班</td><td>${afternoon.join('、')}</td><td></td><td></td><td>${afternoon.length || ''}</td><td></td></tr>
                            <tr><td>晚班</td><td>${evening.join('、')}</td><td></td><td></td><td></td><td>${evening.length || ''}</td></tr>
                            ${'<tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>'.repeat(2)}
                        </table>
                        <div class="mt-2 text-[9px]">
                            <div>休假人員：${holidaysList.join('、') || '無'}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += block;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
